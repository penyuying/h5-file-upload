/*!
 * h5-file-upload v1.0.3
 * (c) 2017-2018 penyuying
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.FileUpload={})}(this,function(e){"use strict";function t(e,t){var n=-1;if(!e||!t||t.length<=0)return-1;"string"==typeof e&&(e=e.toLowerCase());for(var i=0;i<t.length;i++){var o=t[i];if("string"==typeof o&&(o=o.toLowerCase()),e==o){n=i;break}}return n}function n(e,t){try{return new Blob(e,{type:t})}catch(i){var n=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MSBlobBuilder);return e.forEach(function(e){n.append(e)}),n.getBlob(t)}}function i(e,t,n,i,o,a){var r=e.src.length,l=e.width,s=l,p=e.height,f=p,c=1,u=0,d=document.createElement("canvas"),h=d.getContext("2d"),m=document.createElement("canvas"),g=m.getContext("2d");(u=function(e,t,n){var i=e/(n.compressWidth>0&&n.compressWidth||e)||0,o=t/(n.compressHeight>0&&n.compressHeight||t)||0,a=Math.sqrt(e*t/(n.compressTotal>0&&n.compressTotal||e*t))||1;return Math.max(Math.max(i,o)||0,a)||1}(s,f,a))>1&&(l/=c=u,p/=c),a.onCompressStart&&a.onCompressStart instanceof Function&&a.onCompressStart({el:o,fileKey:a.fileKey,index:n,file:i,size:r,width:s,height:f,compressWidth:l,compressHeight:p,ratio:c}),d.width=l,d.height=p,h.fillStyle=a.compressBg||"rgba(255, 255, 255, 0)",h.fillRect(0,0,d.width,d.height);var v=void 0;if((v=l*p/(a.tile||1e6))>1){var y=~~(l/(v=~~(Math.sqrt(v)+1))),b=~~(p/v);m.width=y,m.height=b;for(var x=0;x<v;x++)for(var _=0;_<v;_++)g.drawImage(e,x*y*c,_*b*c,y*c,b*c,0,0,y,b),h.drawImage(m,x*y,_*b,y,b)}else h.drawImage(e,0,0,l,p);var w=d.toDataURL(t||"image/png",a.encoderOptions||.6);return a.onCompress&&a.onCompress instanceof Function&&a.onCompress({el:o,fileKey:a.fileKey,index:n,file:i,base64Data:w,currentSize:w.length,size:r,ratio:~~(100*(r-w.length)/r)+"%",width:s,height:f,compressWidth:l,compressHeight:p}),m.width=m.height=d.width=d.height=0,w}function o(e,o,a,r,l){var s=e.name.split(".").pop();if(!s||t(s.toLowerCase(),["jpg","jpeg","png","gif","bmp","jpe"])<0||!r.compressMinSize||e.size<=1024*r.compressMinSize)return"function"==typeof l&&l(e,o),e;var p=new FileReader;p.onload=function(){function t(){var t=i(p,e.type,o,e,a,r);t=function(e,t,i){for(var o=window.atob(e.split(",")[1]),a=new Uint8Array(o.length),r=0;r<o.length;r++)a[r]=o.charCodeAt(r);var l=n([a],t);return l.name=i||"",l}(t,e.type,e.name),"function"==typeof l&&l(t,o),p=null}var s=this.result,p=new Image;p.src=s,p.complete?t():p.onload=t},p.readAsDataURL(e)}function a(){return~navigator.userAgent.indexOf("Android")&&~navigator.vendor.indexOf("Google")&&!~navigator.userAgent.indexOf("Chrome")&&navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop()<=534?new function(){var e=this,t=[],i=Array(21).join("-")+(+new Date*(1e16*Math.random())).toString(36),o=XMLHttpRequest.prototype.send;this.append=function(e,n,o){t.push("--"+i+'\r\nContent-Disposition: form-data; name="'+e+'"'),n instanceof Blob?(t.push('; filename="'+(o||"blob")+'"\r\nContent-Type: '+n.type+"\r\n\r\n"),t.push(n)):t.push("\r\n\r\n"+n),t.push("\r\n")},XMLHttpRequest.prototype.send=function(a){var r=void 0,l=void 0,s=this;a===e?(t.push("--"+i+"--\r\n"),l=n(t),(r=new FileReader).onload=function(){o.call(s,r.result)},r.onerror=function(e){throw e},r.readAsArrayBuffer(l),this.setRequestHeader("Content-Type","multipart/form-data; boundary="+i),XMLHttpRequest.prototype.send=o):o.call(this,a)}}:new FormData}function r(e,t){if(e=e||{},!t)return e;for(var n in t)e[n]instanceof Object?r(e[n],t[n]):e[n]=t[n];return e}function l(e){for(var t=[],n=e.split(";"),i=0,o=n.length;i<o;i++){var a=n[i].split(".").pop();a&&t.push(a.toLowerCase())}return t}function s(e){var t="";if(!e)return t;switch(e=(e+"").replace(/\*|\.|\s+/g,"").toLowerCase()){case"3gpp":t="audio/3gpp,video/3gpp";break;case"ac3":t="audio/ac3";break;case"asf":t="allpication/vnd.ms-asf";break;case"au":t="audio/basic";break;case"css":t="text/css";break;case"csv":t="text/csv";break;case"rtf":t="application/rtf,text/rtf";break;case"htm":case"html":t="text/html";break;case"xhtml":t="application/xhtml+xml";break;case"js":t="text/javascript,application/javascript";break;case"txt":t="text/plain";break;case"xml":t="text/xml,application/xml";break;case"dwg":t="image/vnd.dwg";break;case"dxf":t="image/vnd.dxf";break;case"gif":t="image/gif";break;case"jp2":t="image/jp2";break;case"jpe":case"jpeg":case"jpg":t="image/jpeg";break;case"png":t="image/png";break;case"svf":t="image/vnd.svf";break;case"tif":case"tiff":t="image/tiff"}return t}function p(e,n){if(e){var i=n.accept&&n.accept.split(",")||function(e){var t=[];if(e&&e.length>0)for(var n=0;n<e.length;n++){var i=s(e[n]);i&&t.push(i)}return t}(l(n.fileTypeExts))||[],o="";if(n.capture){o='capture="'+n.capture+'"';var a=n.capture.split(",")||[];t("camera",a)>-1&&t("image/*",i)<0&&i.unshift("image/*"),t("camcorder",a)>-1&&t("video/*",i)<0&&i.unshift("video/*"),t("microphone",a)>-1&&t("audio/*",i)<0&&i.unshift("audio/*")}i=i.length>0?i.join(","):"*";var r=function(e,t){var n=document.createDocumentFragment(),i=document.createElement("div");n.appendChild(i),i.innerHTML=e;for(var o=i.childNodes||[],a=0;a<o.length;a++)n.appendChild(o[a]);return n.removeChild(i),n}('<div style="display:inline-block;position: absolute;top: 0;left: 0;width: 100%;height: 100%;overflow: hidden;">\n                <span class="_select-btn-text_" style="display:inline-block;width:100%;line-height:50px;text-align:center;font-size: 12px;color:#999999;">'+n.buttonText+'</span>\n                <input class="_select-file-btn_"\n                style="display:block;position: absolute;top: 0;left: 0;width: 100%;height: 100%;font-size: 1000000px;filter: alpha(opacity=0);opacity: 0;"\n                '+(n.multi?" multiple":"")+'\n                type="file" name="fileselect" accept="'+i+'" '+o+">\n            </div>"),p=r.querySelectorAll("input"),f=r.querySelectorAll("div");return e.style.position="relative",e.appendChild(r),{fileInputWrap:f&&f[0]||null,fileInput:p&&p[0]||null}}}function f(e,t){return e=e>1048576&&!t?(Math.round(100*e/1048576)/100).toString()+"MB":(Math.round(100*e/1024)/100).toString()+"KB"}function c(e,t){if(e){this._el=e;(this._options=r(u,t)).el=e,this._ongoingIndex=-1,this._init()}}var u={fileKey:null,fileTypeExts:"*.jpg;*.png;*.gif;*.jpeg",accept:"",capture:"",uploader:"",auto:!0,async:!0,method:"post",multi:!0,formData:null,dataType:"",fileObjName:"file",fileSizeLimit:10240,showUploadedPercent:!0,showUploadedSize:!1,buttonText:"\u9009\u62e9\u6587\u4ef6",compressWidth:1920,compressHeight:1920,compressTotal:0,compressMinSize:100,compressBg:"rgba(0, 0, 0, 0)",encoderOptions:.8,tile:1e6,removeTimeout:1e3,itemTemplate:"",onReaderFile:null,onUploadStart:null,onProgress:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onCompressStart:null,onCompress:null,onSizeError:null,onFileTypeError:null,onInit:null,onCancel:null};c.prototype={_init:function(){var e=this,t=e._options,n=e._el;e._files=null;var i=e._fileObj=p(n,t)||{};i.fileInput&&i.fileInput.addEventListener("change",function(t){e._funGetFiles(t)}),t.onInit&&t.onInit instanceof Function&&t.onInit&&t.onInit({el:n,fileKey:t.fileKey})},_funUploadFile:function(e,t,n,i){var o=this,r=function(){var e=void 0;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){e=new ActiveXObject("Microsoft.XMLHTTP")}}return e}()||!1,l=o._options,s=o._el,p=0;if(r&&r.upload&&e){r.upload.addEventListener("progress",function(n){p=n.total,o._onProgress(t,e,n.loaded,p)},!1),r.onreadystatechange=function(a){if(4==r.readyState){if(200==r.status){var f=r.responseText;o._onProgress(t,e,p,p),"json"==l.dataType&&(f=JSON.parse(r.responseText)),"function"==typeof l.onUploadSuccess&&l.onUploadSuccess({el:s,fileKey:l.fileKey,file:e,index:t,fileCount:n},f)}else"function"==typeof l.onUploadError&&l.onUploadError({el:s,fileKey:l.fileKey,file:e,index:t,fileCount:n},r);"function"==typeof i&&i({el:s,fileKey:l.fileKey,file:e,index:t,fileCount:n},r)}},l.onUploadStart&&l.onUploadStart({el:s,fileKey:l.fileKey,file:e,index:t,fileName:e.name,fileCount:n}),r.open(l.method,l.uploader,l.async||!0),r.setRequestHeader("X-Requested-With","XMLHttpRequest");var f=a();if(e.name?f.append(l.fileObjName,e,e.name):f.append(l.fileObjName,e),l.formData)for(var c in l.formData)f.append(c,l.formData[c]);r.send(f)}},delFile:function(e){return!!(this._ongoingIndex+""==e+""&&this._files&&this._files.length>0)&&(this._files.splice(e,1),!0)},_funGetFiles:function(e){var n=this._options,i=e.target.files;this._files=null,n.onReaderFile instanceof Function&&n.onReaderFile({el:this._el,fileKey:n.fileKey,files:i}),i=function(e,n,i){var o=[],a=l(i.fileTypeExts);if(a.length>0)for(var r=0,s=e.length;r<s;r++){var p=e[r];parseInt(f(p.size,!0))>i.fileSizeLimit?i.onSizeError instanceof Function&&i.onSizeError({el:n,fileKey:i.fileKey,index:r,fileName:p.name,file:p,maxSize:f(1024*i.fileSizeLimit||0,!0),size:f(p.size,!0)}):t(p.name.split(".").pop(),a)>=0?o.push(p):i.onFileTypeError&&i.onFileTypeError instanceof Function&&i.onFileTypeError({el:n,fileKey:i.fileKey,index:r,fileName:p.name,file:p,type:p.name.split(".").pop(),typeArray:a})}return o}(i,this._el,n),this._files=i,n.auto&&this.submitUpload()},submitUpload:function(){function e(o,a,r){a<r?(t._ongoingIndex=a,o?t._execUpload(o,a,r,function(i,o){n.onUploadComplete&&n.onUploadComplete(i,o),e(t._files[a+1],a+1,t._files.length)}):e(t._files[a+1],a+1,t._files.length)):(i.fileInput.value="",i=null,t._files=null,t._ongoingIndex=-1)}var t=this,n=t._options,i=t._fileObj;e(t._files[0],0,t._files.length)},_execUpload:function(e,t,n,i){var a=this,r=a._options;try{o(e,t,a._el,r,function(e,t){a._funUploadFile(e,t,n,i)})}catch(o){a._funUploadFile(e,t,n,i)}},_onProgress:function(e,t,n,i){var o=this._options;"function"==typeof o.onProgress&&o.onProgress({el:this._el,fileKey:o.fileKey,index:e,file:t,loaded:n,total:i})}},e.FileUpload=c,Object.defineProperty(e,"__esModule",{value:!0})});